<script>

const container=document.getElementById("levels");
for(let i=1;i<=30;i++){
  let d=document.createElement("div");
  d.className="level";
  d.innerText="Level "+i;
  if(i>=5) d.classList.add("locked");
  else d.onclick=()=>startLevel(i);
  container.appendChild(d);
}

let currentTarget="";
let mode="letters"; // letters OR phrases
let detectionTimer=null;

const letters=["A","B","C"];
const phrases=["HELLO","THANK YOU","YES"];

function startLevel(level){

  document.getElementById("lessonBox").style.display="block";
  document.getElementById("lessonTitle").innerText="Level "+level;

  if(level===2){
    mode="letters";
    beginAIScanner();
  }

  if(level===4){
    mode="phrases";
    beginAIScanner();
  }
}

async function beginAIScanner(){

  if(mode==="letters"){
    currentTarget=letters[Math.floor(Math.random()*letters.length)];
  } else {
    currentTarget=phrases[Math.floor(Math.random()*phrases.length)];
  }

  document.getElementById("lessonContent").innerHTML=`
    <p>Sign: <strong>${currentTarget}</strong></p>
    <video id="vid" autoplay playsinline></video>
    <div id="scanStatus">Requesting camera...</div>
    <div class="bigResult" id="bigResult"></div>
  `;

  speakTiger("Hold your sign steady...");

  const video=document.getElementById("vid");

  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
    document.getElementById("scanStatus").innerText="Scanning...";
  }catch(e){
    document.getElementById("scanStatus").innerText="Camera blocked!";
    speakTiger("I need camera permission!");
    return;
  }

  const hands=new Hands({
    locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands:1,
    minDetectionConfidence:0.7,
    minTrackingConfidence:0.7
  });

  hands.onResults(res=>{
    if(res.multiHandLandmarks.length>0){

      const guess=detectGesture(res.multiHandLandmarks[0]);

      if(guess===currentTarget){
        if(!detectionTimer){
          detectionTimer=setTimeout(()=>{
            showResult(true);
            detectionTimer=null;
          },1000); // must hold 1 sec
        }
      } else {
        clearTimeout(detectionTimer);
        detectionTimer=null;
      }
    }
  });

  new Camera(video,{
    onFrame:async()=>{await hands.send({image:video});},
    width:360,
    height:270
  }).start();
}

function showResult(correct){

  const result=document.getElementById("bigResult");

  if(correct){
    result.innerText="YES! YOU GOT IT!";
    result.style.color="#3b82f6";
    document.getElementById("tiger").innerText="ğŸ¯ğŸ˜„";
    speakTiger("YESSS! That was perfect!");
  }else{
    result.innerText="TRY AGAIN!";
    result.style.color="#ef4444";
    document.getElementById("tiger").innerText="ğŸ¯ğŸ˜¢";
    speakTiger("Almost! Adjust your hand.");
  }
}

function detectGesture(lm){

  const wrist=lm[0];
  const index=lm[8];
  const middle=lm[12];
  const thumb=lm[4];

  if(mode==="letters"){

    if(distance(index,wrist)<0.12 &&
       distance(middle,wrist)<0.12) return "A";

    if(index.y<lm[6].y &&
       middle.y<lm[10].y) return "B";

    if(distance(thumb,index)>0.18) return "C";

  }

  if(mode==="phrases"){

    // HELLO (open hand upright)
    if(index.y<lm[6].y &&
       middle.y<lm[10].y &&
       thumb.x<index.x) return "HELLO";

    // THANK YOU (thumb near mouth area)
    if(distance(thumb,index)<0.08) return "THANK YOU";

    // YES (fist)
    if(distance(index,wrist)<0.12 &&
       distance(middle,wrist)<0.12) return "YES";
  }

  return "Unknown";
}

function distance(a,b){
  return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);
}

function speakTiger(text){
  document.getElementById("tigerSpeech").innerText=text;
}

</script>
